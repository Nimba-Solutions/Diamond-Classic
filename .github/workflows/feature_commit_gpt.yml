name: Enhance User Commit with GPT

on:
  push:
    branches:
      - 'feature/**__*'
jobs:
  build_payload:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Get commit message
      run: echo "commit_message=$(git log -1 --pretty=%B)" >> $GITHUB_ENV

    - name: Get changed files
      run: echo "changed_files=$(git diff-tree --no-commit-id --name-only -r $GITHUB_SHA)" >> $GITHUB_ENV

    - name: Get file diffs
      run: |
        changed_files="$(echo "$changed_files")"
        changed_files_array=($changed_files)

        file_diffs=""
        if [ "$(git rev-list --count HEAD)" -gt 1 ]; then
          for file in "${changed_files_array[*]}"; do
            file_diff="$(git diff HEAD..HEAD^ -- "$file")"
            file_diffs="$file_diffs\n{\"filename\":\"$file\",\"diff\":\"$file_diff\"}"
          done
        fi

        echo "file_diffs=[$file_diffs]" >> $GITHUB_ENV

  post_payload:
    runs-on: ubuntu-latest
    needs: build_payload
    steps:
    - name: Create JSON payload
      run: |
        echo '{
          "instructions": "Please review and concisely summarize each of the changes",
          "commit_message": "$commit_message",
          "changes": $file_diffs
        }' > payload.json

    - name: Post JSON payload
      run: |
        apk add --no-cache curl
        response="$(curl -X POST -H "Content-Type: application/json" -d "@payload.json" "http://nimbot.herokuapp.com/ProcessText")"
        echo "Response: $response"

    - name: Save result in original commit
      run: |
        echo "$response" > result.txt
        git config --global user.email "you@example.com"
        git config --global user.name "Your Name"
        git add result.txt
        git commit --amend --no-edit
        git push -f origin HEAD:$GITHUB_REF
