name: Enhance User Commit with GPT

on:
  push:
    branches:
      - 'feature/**__*'

jobs:
  build_payload:
    runs-on: ubuntu-latest
    outputs:
      commit_message: ${{ steps.get_commit_message.outputs.commit_message }}
      file_diffs: ${{ steps.get_file_diffs.outputs.file_diffs }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Get commit message
      id: get_commit_message
      run: echo "::set-output name=commit_message::$(git log -1 --pretty=%B)"

    - name: Get changed files
      run: |
        echo "::set-output name=changed_files::$(git diff-tree --no-commit-id --name-only -r $GITHUB_SHA)"

    - name: Get file diffs
      id: get_file_diffs
      run: |
        changed_files="$(echo "${ changed_files }")"
        changed_files_array=($changed_files)

        file_diffs=""
        for file in "${ changed_files_array[@] }"; do
          file_diff="$(git diff HEAD..HEAD^ -- "$file")"
          file_diffs="$file_diffs\n{\"filename\":\"$file\",\"diff\":\"$file_diff\"}"
        done

        echo "::set-output name=file_diffs::[$file_diffs]"

  post_payload:
    runs-on: ubuntu-latest
    needs: build_payload
    steps:
    - name: Create JSON payload
      run: |
        echo '{
          "instructions": "Please review and concisely summarize each of the changes",
          "commit_message": "${{ needs.build_payload.outputs.commit_message }}",
          "changes": ${{ needs.build_payload.outputs.file_diffs }}
        }' > payload.json

    - name: Post JSON payload
      run: |
        apk add --no-cache curl
        response="$(curl -X POST -H "Content-Type: application/json" -d "@payload.json" "http://nimbot.herokuapp.com/ProcessText")"
        echo "Response: $response"

    - name: Save result in original commit
      run: |
        echo "$response" > result.txt
        git config --global user.email "you@example.com"
        git config --global user.name "Your Name"
        git add result.txt
        git commit --amend --no-edit
        git push -f origin HEAD:$GITHUB_REF
